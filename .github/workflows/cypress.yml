name: Cypress tests
on: push
env:
  PHP_VERSION: '8.1'
jobs:
  install:
    runs-on: ubuntu-latest
#    container:
#      image: cypress/browsers:node-20.9.0-chrome-118.0.5993.88-1-ff-118.0.2-edge-118.0.2088.46-1
#      options: --user 1001
    steps:
      - name: Setup PHP, with composer and extensions
        uses: shivammathur/setup-php@v2 #https://github.com/shivammathur/setup-php
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo
          #coverage: xdebug #optional

      - name: Use Node.js 21.x
        uses: actions/setup-node@v2
        with:
          node-version: '21.x'

      - name: Install core app
        run: composer create-project seatplus/core . --prefer-dist --no-dev --no-ansi --no-interaction --no-scripts --no-progress --ignore-platform-reqs

      - name: change required seatplus/web package to use current branch
        run: |
          BRANCH_NAME=$(echo ${{ github.head_ref || github.ref_name }})
          composer require seatplus/web:"dev-${BRANCH_NAME}" --ignore-platform-reqs

      - name: setup Laravel
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: install laracasts/cypress
        run: |
          composer require laracasts/cypress --dev --ignore-platform-reqs
          npm install cypress --save-dev
          php artisan cypress:boilerplate --force

      - name: delete integration tests
        run: rm -rf tests/cypress/integration

      - name: change base url in cypress.config.js
        run: sed -i 's/localhost/localhost:8000/' cypress.config.js

      - name: publish cypress tests
        run: php artisan vendor:publish --tag=web-test-cypress --force

      - name: install npm dependencies and build assets
        run: npm install && npm run prod

#      - name: Cypress run
#        uses: cypress-io/github-action@v6
#        with:
#          build: npm run prod
#          runTests: false
      - name: compress repo
        run: |
          tar -czf ../build.tar.gz ./
          mv ../build.tar.gz build.tar.gz

      - name: Save build folder
        uses: actions/upload-artifact@v3
        with:
          name: SeatPlus
          if-no-files-found: error
          path: build.tar.gz
          retention-days: 1


  ui-chrome-tests:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node-20.9.0-chrome-118.0.5993.88-1-ff-118.0.2-edge-118.0.2088.46-1
      options: --user 1001
    needs: install
    steps:
      - name: Download the build folders
        uses: actions/download-artifact@v3
        with:
          name: SeatPlus
          path: build.tar.gz

      - name: Extract the build folders
        run: tar -xzf build.tar.gz

      - name: PHP, Composer, Extensions, MariaDB, Redis
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo
          #coverage: xdebug #optional
      - uses: getong/mariadb-action@v1.1
        with:
          #host port: 3308 # Optional, default value is 3306. The port of host
          mariadb version: '10.7' # Optional, default value is "latest". The version of the MariaDB
          mysql database: 'seatplus' # Optional, default value is "test". The specified database which will be create
          mysql user: 'seatplus' # Required if "mysql root password" is empty, default is empty. The superuser for the specified database. Can use secrets, too
          mysql password: 'secret' # Required if "mysql user" exists. The password for the "mysql user"
      - uses: supercharge/redis-github-action@1.1.0
        with:
          # Redis version to use
          redis-version: 5 # optional, default is latest

      - name: run migrations
        run: php artisan migrate --force

      - name: "UI Tests - Chrome"
        uses: cypress-io/github-action@v6
        with:
          start: php artisan serve
          wait-on: http://localhost:8000
          browser: chrome

  ui-chrome-mobile-tests:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node-20.9.0-chrome-118.0.5993.88-1-ff-118.0.2-edge-118.0.2088.46-1
      options: --user 1001
    needs: install
    steps:
      - name: Download the build folders
        uses: actions/download-artifact@v3
        with:
          name: build
          path: build

      - name: "UI Tests - Chrome Mobile"
        uses: cypress-io/github-action@v6
        with:
          start: php artisan serve
          wait-on: http://localhost:8000
          browser: chrome
          config: viewportWidth=375,viewportHeight=667